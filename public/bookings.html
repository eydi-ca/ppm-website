<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Session | Profilepic</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <style>
        /* [KEEP EXISTING CSS, ADDING NEW STYLES FOR FEATURES] */
        :root { --primary: #0A142D; --accent: #e67e22; --bg-body: #F4F7FE; --text-main: #2B3674; --text-muted: #A3AED0; --border-color: #E0E5F2; }
        body { font-family: "DM Sans", sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; display: block; min-height: 100vh; justify-content: center; min-height: 100vh; }
        .bk-page { display: flex; gap: 30px; width: 100%; max-width: 1200px; padding: 40px 20px; align-items: flex-start; margin: 0 auto; margin-top: 50px; margin-bottom: 50px; }
        .form-card { flex: 2; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .summary-card { flex: 1; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); position: sticky; top: 40px; }
        .section-title { font-weight: 700; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .bk-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .bk-col { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .bk-label { font-size: 14px; font-weight: 600; }
        .bk-required { color: #e74c3c; }
        .bk-input, .bk-select { padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border-color); font-family: inherit; font-size: 14px; width: 100%; box-sizing: border-box; transition: 0.2s; }
        .bk-input:focus, .bk-select:focus { outline: none; border-color: var(--accent); }
        
        /* NEW PACKAGE GRID */
        .package-grid { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .package-card { flex: 1; min-width: 220px; border: 2px solid var(--border-color); border-radius: 12px; padding: 25px; cursor: pointer; transition: 0.2s; position: relative; display: flex; flex-direction: column; }
        .package-card:hover { border-color: #ddd; transform: translateY(-3px); }
        .package-card.selected { border-color: var(--accent); background-color: #fff8f3; }
        
        .pkg-name { font-weight: 700; font-size: 16px; margin-bottom: 5px; color: var(--primary); }
        .pkg-price { font-size: 22px; color: var(--accent); font-weight: 800; margin-bottom: 15px; }
        
        /* Feature List */
        .pkg-features { list-style: none; padding: 0; margin: 0; text-align: left; font-size: 13px; color: #555; }
        .pkg-features li { margin-bottom: 8px; display: flex; align-items: flex-start; gap: 8px; }
        .pkg-features li i { color: #27ae60; margin-top: 3px; }

        .summary-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--primary); }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #555; }
        .summary-tax { color: #e67e22; font-size: 13px; } 
        .total-divider { height: 1px; background: #eee; margin: 20px 0; }
        .summary-total { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .total-price { font-size: 26px; font-weight: 800; color: var(--accent); }
        .bk-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-primary { background: var(--accent); color: white; margin-bottom: 10px; }
        .btn-secondary { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); }
        
        @media (max-width: 800px) { .bk-page { flex-direction: column; } .bk-row { flex-direction: column; gap: 15px; } .summary-card { width: 100%; position: static; } }
    </style>
</head>
<body>

  <!-- ===== NAVBAR ===== -->
  <header class="navbar">
    <div class="nav-container">
      <div class="logo">
        <!-- Replace this with your actual logo image -->
        <img src="logos/logo3.png" alt="Profilepic Multimedia Logo" />
      </div>

      <nav class="nav-links">
        <a href="index.html" class="active">Home</a>
        <a href="about.html">About Us</a>
        <a href="package.html">Package & Booking</a>
        <!--
        <div class="dropdown">
          <button class="dropbtn">Services â–¾</button> 
          <div class="dropdown-content">
            <a href="service_and_packages.html">Photography Packages</a>
            <a href="#locations-section">Locations</a>
            <a href="#how-it-works">Booking Guide</a>
          </div>
        </div>-->

        <a href="gallery.html">Gallery</a>
        <a href="contact.html">Contact</a>
        
        <div class="account-icon" id="account-nav">
          <!-- This will be updated by JS -->
        </div>
      </nav>
    </div>
  </header>

    <main class="bk-page">
        <div class="form-card">
            <h1 style="margin-bottom: 5px; color: var(--primary);">Book Your Session</h1>
            <p style="margin-bottom: 25px; color: var(--text-muted); font-size: 14px;">Online bookings include <strong>Free Full Gallery Access!</strong></p>

            <form id="bkForm" onsubmit="return false;">
                
                <div class="section-title"><i class="fa-regular fa-user"></i> Your Details</div>
                <div class="bk-row">
                    <div class="bk-col"><label class="bk-label">Name</label><input id="fullName" class="bk-input" placeholder="Fetching..." readonly /></div>
                    <div class="bk-col"><label class="bk-label">Email</label><input id="email" class="bk-input" placeholder="Fetching..." readonly /></div>
                </div>
                <div class="bk-row">
                    <div class="bk-col"><label class="bk-label">Phone</label><input id="phoneNumber" class="bk-input" placeholder="e.g. 0912 345 6789" required /></div>
                </div>

                <div class="section-title" style="margin-top: 30px;"><i class="fa-solid fa-map-location-dot"></i> Location & Date</div>
                
                <div class="bk-row">
                    <div class="bk-col">
                        <label class="bk-label">Location <span class="bk-required">*</span></label>
                        <select id="location" class="bk-select" required onchange="onLocationChange()">
                            <option value="">-- Select Location --</option>
                            <option value="Ilocos">Ilocos Norte (Sand Dunes)</option>
                            <option value="Albay">Daraga, Albay (ATV)</option>
                        </select>
                    </div>
                    <div class="bk-col">
                        <label class="bk-label">Number of Guests</label>
                        <input id="guestCount" type="number" class="bk-input" value="1" min="1" max="20" onchange="updateSummary()" />
                    </div>
                </div>

                <div class="bk-row">
                    <div class="bk-col">
                        <label class="bk-label">Date</label>
                        <input id="date" class="bk-input" type="date" required onchange="updateSummary()" />
                    </div>
                    <div class="bk-col">
                        <label class="bk-label">Time Slot</label>
                        <select id="time" class="bk-select" required onchange="updateSummary()">
                            <option>08:00 AM</option><option>10:00 AM</option>
                            <option>02:00 PM</option><option>04:00 PM (Sunset)</option>
                        </select>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;"><i class="fa-solid fa-camera"></i> Select Package</div>
                <div id="dynamicPackageContainer" class="package-grid">
                    <p style="color:#A3AED0; font-style:italic;">Please select a location above to see packages.</p>
                </div>

                <div class="section-title" style="margin-top: 30px;"><i class="fa-regular fa-credit-card"></i> Payment Method</div>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Transaction fees calculated automatically.</p>
                
                <div class="bk-row">
                    <div class="bk-col">
                        <label class="bk-label">Pay With <span class="bk-required">*</span></label>
                        <select id="paymentMethod" class="bk-select" required onchange="updateSummary()">
                            <option value="wallet">E-Wallet (GCash / Maya) - Lower Fees</option>
                            <option value="card">Credit / Debit Card</option>
                        </select>
                    </div>
                </div>

                <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; font-size: 13px; margin-top: 20px;">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <input id="agree" type="checkbox" /> 
                        <span>I agree to the <strong>Terms & Conditions</strong>.</span>
                    </label>
                </div>

            </form>
        </div>

        <div class="summary-card">
            <div class="summary-header">Booking Summary</div>
            
            <div class="summary-item"><span>Location</span> <strong id="sumLoc">--</strong></div>
            <div class="summary-item"><span>Date</span> <strong id="sumDate">--</strong></div>
            <div class="summary-item"><span>Package</span> <strong id="sumPkg">--</strong></div>
            <div class="summary-item"><span>Guests</span> <strong id="sumGuests">1 Pax</strong></div>
            
            <div class="total-divider"></div>

            <div class="summary-item"><span>Subtotal</span> <strong id="sumSubtotal">â‚±0</strong></div>
            <div class="summary-item summary-tax"><span>Processing Fee</span> <strong id="sumTax">â‚±0</strong></div>

            <div class="total-divider"></div>
            
            <div class="summary-total">
                <span>Total Due</span>
                <span class="total-price" id="sumTotal">â‚±0</span>
            </div>
            
            <button id="bkSubmit" class="bk-btn btn-primary">Proceed to Payment</button>
            <button onclick="window.location.reload()" class="bk-btn btn-secondary">Reset</button>
            
            <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #999;">
                <i class="fa-solid fa-lock"></i> Secure Payment Gateway
            </div>
        </div>

    </main>

  

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = "login.html";

        // ==========================================
        // 1. DATA & CONFIG
        // ==========================================
        const PACKAGES_DB = {
            'Ilocos': [
                { id: 'suba1', name: 'Suba Standard', price: 2500, features: ['4x4 Ride', 'Sandboarding', 'Driver Included', 'Digital Photos'] },
                { id: 'suba2', name: 'Suba Premium', price: 3500, features: ['Sunset Ride', 'Sandboarding', 'Snacks & Drinks', 'Priority Editing'] }
            ],
            'Albay': [
                { id: 'mtv1', name: 'Lava Trail', price: 1500, features: ['ATV Ride', 'Safety Gear', 'Guide Assisted'] },
                { id: 'mtv2', name: 'Summit View', price: 2000, features: ['Extended Route', 'Summit Photo Op', 'Refreshments'] }
            ]
        };

        const FEES = { 'wallet': { rate: 0.029, fixed: 0 }, 'card': { rate: 0.035, fixed: 15 } };
        
        let selectedPackageName = "";
        let selectedPackagePrice = 0;
        let finalChargeAmount = 0;

        // ==========================================
        // 2. RENDER PACKAGES
        // ==========================================
        function onLocationChange() {
            console.log("Location Changed...");
            const locSelect = document.getElementById('location');
            const container = document.getElementById('dynamicPackageContainer');
            const selectedLoc = locSelect.value;

            // Clear old cards
            container.innerHTML = '';
            
            // Reset Selection
            selectedPackageName = ""; 
            selectedPackagePrice = 0;
            updateSummary();

            if (!selectedLoc || !PACKAGES_DB[selectedLoc]) {
                container.innerHTML = '<p style="color:#A3AED0; width:100%;">Please select a location above.</p>';
                return;
            }

            // Create New Cards
            PACKAGES_DB[selectedLoc].forEach(pkg => {
                let featuresHtml = pkg.features.map(f => `<li><i class="fa-solid fa-check"></i> ${f}</li>`).join('');

                const card = document.createElement('div');
                card.className = 'package-card';
                card.onclick = () => selectPackage(card, pkg.name, pkg.price);
                
                card.innerHTML = `
                    <span class="pkg-name">${pkg.name}</span>
                    <span class="pkg-price">â‚±${pkg.price.toLocaleString()}</span>
                    <ul class="pkg-features">${featuresHtml}</ul>
                `;
                container.appendChild(card);
            });
        }

        function selectPackage(card, name, price) {
            console.log("Selected:", name, price);
            document.querySelectorAll('.package-card').forEach(el => el.classList.remove('selected'));
            card.classList.add('selected');
            
            selectedPackageName = name;
            selectedPackagePrice = price;
            updateSummary();
        }

        // ==========================================
        // 3. MATH & SUMMARY
        // ==========================================
        function updateSummary() {
            const loc = document.getElementById('location').value || "--";
            const date = document.getElementById('date').value || "--";
            const guests = parseInt(document.getElementById('guestCount').value) || 1;
            const method = document.getElementById('paymentMethod').value || 'wallet';

            // 1. Base Subtotal
            const subtotal = guests * selectedPackagePrice;

            // 2. Gross-Up Calculation
            const feeConfig = FEES[method];
            const grossAmount = (subtotal + feeConfig.fixed) / (1 - feeConfig.rate);
            const processingFee = grossAmount - subtotal;

            // 3. Update UI
            document.getElementById('sumLoc').innerText = loc;
            document.getElementById('sumDate').innerText = date;
            document.getElementById('sumPkg').innerText = selectedPackageName || "Select Pkg";
            document.getElementById('sumGuests').innerText = guests + " Pax";
            
            document.getElementById('sumSubtotal').innerText = 'â‚±' + subtotal.toLocaleString();
            document.getElementById('sumTax').innerText = '+ â‚±' + processingFee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('sumTotal').innerText = 'â‚±' + grossAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // 4. Store Final Amount for Submission
            finalChargeAmount = grossAmount;
        }

        // ==========================================
        // 4. USER LOADING
        // ==========================================
        async function loadUser() {
            try {
                const res = await fetch('/api/user/profile', { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.ok) {
                    const user = await res.json();
                    const fullName = (user.first_name || "") + " " + (user.last_name || "");
                    document.getElementById('fullName').value = fullName.trim() || "Guest";
                    document.getElementById('email').value = user.email || "";
                    document.getElementById('phoneNumber').value = user.phone_number || "";
                }
            } catch (err) { console.error(err); }
        }
        
        document.getElementById('date').min = new Date().toISOString().split('T')[0];
        loadUser();

        // ==========================================
        // 5. SUBMIT TO BACKEND
        // ==========================================
        document.getElementById('bkSubmit').addEventListener('click', async () => {
            const btn = document.getElementById('bkSubmit');
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const guests = parseInt(document.getElementById('guestCount').value);
            const agree = document.getElementById('agree').checked;

            if(!selectedPackageName || !date || !time) { alert("Please complete the form."); return; }
            if(!agree) { alert("Please agree to the terms."); return; }

            // Recalculate Per-Pax Price to include Tax
            // (Total Gross / Guests) = Price to send to Backend
            const effectivePricePerPax = finalChargeAmount / guests;

            console.log(`Sending to Backend: Total=${finalChargeAmount}, Guests=${guests}, PerPax=${effectivePricePerPax}`);

            btn.innerText = 'Processing...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/booking/create-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        tourName: selectedPackageName,
                        date: date,
                        time: time,
                        guests: guests,
                        pricePerPax: effectivePricePerPax // ðŸ‘ˆ Sends the Dynamic Price
                    })
                });

                const data = await res.json();

                if (res.ok && data.checkout_url) {
                    localStorage.setItem('pending_booking_id', data.session_id);
                    window.location.href = data.checkout_url;
                } else {
                    alert("Error: " + data.message);
                    btn.disabled = false;
                    btn.innerText = "Proceed to Payment";
                }
            } catch (err) {
                console.error(err);
                alert("Network error.");
                btn.disabled = false;
                btn.innerText = "Proceed to Payment";
            }
        });
    </script>

       <!-- ===== FOOTER SECTION ===== -->
    <footer>
        <div class="footer-container">
            <!-- LEFT: Logo and Contact -->
            <div class="footer-logo-section">
                <div class="footer-logo">
                    <img src="images/logo_wbg.png" alt="ProfilePic Multimedia">
                </div>
                <div class="footer-contact">
                    <p>0976 004 2741</p>
                    <p>profilepicmultimedia@gmail.com</p>
                </div>
            </div>

            <!-- Navigation -->
              <div class="footer-column">
                  <h3>Discover</h3>
                  <ul>
                      <li><a href="about.html">About Us</a></li>
                      <li><a href="package.html#partner-locations">Partner Locations</a></li>
                      <li><a href="package.html">Packages</a></li>
                      <li><a href="gallery.html">Gallery</a></li>
                      <li><a href="index.html#ntestimonial">Testimonials</a></li>
                  </ul>
              </div>

              <div class="footer-column">
                  <h3>Support</h3>
                  <ul>
                      <li><a href="#">How It Works</a></li>
                      <li><a href="#">Booking Guide</a></li>
                      <li><a href="user/user_gallery.html">My Gallery</a></li>
                      <li><a href="#">Edit My Account</a></li>
                      <li><a href="privacy-policy.html">Payment & Refund Policy</a></li>
                      <li><a href="contact.html">Contact</a></li>
                  </ul>
              </div>

              <!-- Legal -->
              <div class="footer-column">
                  <h3>Legal</h3>
                  <ul>
                      <li><a href="#">Terms & Conditions</a></li>
                      <li><a href="privacy-policy.html">Privacy Policy</a></li>
                      <li><a href="#">FAQs</a></li>
                  </ul>
              </div>

            <!-- Follow Us -->
            <div class="footer-column">
                <h3>Follow us</h3>
                <ul>
                <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M240 363.3L240 576L356 576L356 363.3L442.5 363.3L460.5 265.5L356 265.5L356 230.9C356 179.2 376.3 159.4 428.7 159.4C445 159.4 458.1 159.8 465.7 160.6L465.7 71.9C451.4 68 416.4 64 396.2 64C289.3 64 240 114.5 240 223.4L240 265.5L174 265.5L174 363.3L240 363.3z"/></svg></a>
                <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M544.5 273.9C500.5 274 457.5 260.3 421.7 234.7L421.7 413.4C421.7 446.5 411.6 478.8 392.7 506C373.8 533.2 347.1 554 316.1 565.6C285.1 577.2 251.3 579.1 219.2 570.9C187.1 562.7 158.3 545 136.5 520.1C114.7 495.2 101.2 464.1 97.5 431.2C93.8 398.3 100.4 365.1 116.1 336C131.8 306.9 156.1 283.3 185.7 268.3C215.3 253.3 248.6 247.8 281.4 252.3L281.4 342.2C266.4 337.5 250.3 337.6 235.4 342.6C220.5 347.6 207.5 357.2 198.4 369.9C189.3 382.6 184.4 398 184.5 413.8C184.6 429.6 189.7 444.8 199 457.5C208.3 470.2 221.4 479.6 236.4 484.4C251.4 489.2 267.5 489.2 282.4 484.3C297.3 479.4 310.4 469.9 319.6 457.2C328.8 444.5 333.8 429.1 333.8 413.4L333.8 64L421.8 64C421.7 71.4 422.4 78.9 423.7 86.2C426.8 102.5 433.1 118.1 442.4 131.9C451.7 145.7 463.7 157.5 477.6 166.5C497.5 179.6 520.8 186.6 544.6 186.6L544.6 274z"/></svg></a>
                </ul>
            </div>
            
        </div>

        <div class="footer-bottom">
            <p class="copyright">Copyright Â© ProfilePicMultimedia 2025</p>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    </footer>
</body>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const accountNav = document.getElementById("account-nav");
  const token = localStorage.getItem("token"); // token stored after login

    if (token) {
    // User is logged in
    accountNav.innerHTML = `
      <a href="user/user_gallery.html"><i class="fa-solid fa-user"></i> Profile</a>
      <a href="#" id="logout-btn" style="margin-left:10px; color:#ff4d4d;">Logout</a>
    `;

    // Logout functionality
    document.getElementById("logout-btn").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("token");
      window.location.reload();
    });
  } else {
    // User not logged in
    accountNav.innerHTML = `
      <a href="login.html">Login</a> /
      <a href="signup.html">Signup</a>
    `;
  }
});
</script>
</html>